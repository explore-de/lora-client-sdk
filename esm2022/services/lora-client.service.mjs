import ClientError from "../types/ClientError";
export var ConnectionStatus;
(function (ConnectionStatus) {
    ConnectionStatus["DISCONNECTED"] = "disconnected";
    ConnectionStatus["CONNECTED"] = "connected";
    ConnectionStatus["CONNECTING"] = "connecting";
    ConnectionStatus["ERROR"] = "error";
})(ConnectionStatus || (ConnectionStatus = {}));
var MessageStatus;
(function (MessageStatus) {
    MessageStatus[MessageStatus["Pending"] = 0] = "Pending";
    MessageStatus[MessageStatus["Sent"] = 1] = "Sent";
})(MessageStatus || (MessageStatus = {}));
const HEARTBEAT_INTERVAL = 12000;
export class LoraClientService {
    serviceUrl = 'https://feynsinn.explore.de/lora-minirag';
    url = undefined;
    socket = null;
    isConnected = false;
    isError = false;
    messages = [];
    messagesQueue = [];
    listeners = {};
    heartBeatInterval = 0;
    constructor() {
        console.log('LoraClientService constructor');
    }
    async createSession(token) {
        const response = await window.fetch(`${this.serviceUrl}/session`, {
            headers: { 'x-api-token': token }
        });
        return response.status === 200 ? await response.text() : undefined;
    }
    async connect(options) {
        const sessionId = options.sessionId;
        this.url = options.url ?? `${this.serviceUrl}/ws/${sessionId}`.replace('https://', 'wss://').replace('http://', 'ws://');
        if (!sessionId) {
            throw new ClientError('Can not start connection: session id not set.');
        }
        if (!this.url) {
            throw new ClientError('Can not start connection: server url not set.');
        }
        if (this.socket && this.socket.readyState !== WebSocket.CLOSED) {
            throw new ClientError('WebSocket connection is already open or opening.');
        }
        let oldMessages = [];
        let resolvePromise;
        let rejectPromise;
        const promise = new Promise((resolve, reject) => {
            resolvePromise = resolve;
            rejectPromise = reject;
        });
        this.emitStatus(ConnectionStatus.CONNECTING);
        this.isError = false;
        this.isConnected = false;
        try {
            if (options.loadHistory) {
                oldMessages = await this.getMessagesHistory(sessionId);
            }
            this.socket = new WebSocket(this.url);
            this.socket.onopen = () => {
                oldMessages.forEach(message => this.addMessage(message));
                this.isConnected = true;
                this.startHeartBeat();
                this.emitStatus(ConnectionStatus.CONNECTED);
                resolvePromise();
            };
            this.socket.onmessage = (event) => {
                const response = event.data;
                if (response === 'ping' || response === 'pong')
                    return;
                if (typeof response === 'string') {
                    this.onSocketMessage(response);
                }
            };
            this.socket.onclose = () => {
                this.isConnected = false;
                this.stopHeartBeat();
                this.emitStatus(this.isError ? ConnectionStatus.ERROR : ConnectionStatus.DISCONNECTED);
            };
            this.socket.onerror = (event) => {
                this.isError = true;
                rejectPromise?.(event);
            };
        }
        catch (e) {
            console.error(e);
            return;
        }
        return promise;
    }
    async getMessagesHistory(sessionId) {
        const response = await window.fetch(`${this.serviceUrl}/${sessionId}/messages`);
        const data = await response.json();
        const messages = (data || []).map((item) => {
            const message = {
                id: item.messageId,
                user: item.loraMessage ? 'lora' : 'me',
                content: item.text,
                time: item.creationDate,
                parts: item.parts
            };
            return message;
        });
        return messages.reverse();
    }
    sendMessage(message) {
        this.pushMessageToQueue(message);
        this.processQueue();
    }
    onSocketMessage(data) {
        let json = undefined;
        let content = '';
        let parts = [];
        try {
            json = JSON.parse(data);
            content = json.answer;
            parts = json.parts;
        }
        catch (e) {
            content = data;
        }
        const message = { id: crypto.randomUUID(), user: 'lora', content, parts, time: Date.now() };
        this.addMessage(message);
    }
    processQueue() {
        const message = this.messagesQueue.pop();
        if (!message)
            return;
        this.addMessage({ id: message.id, user: 'me', time: Date.now(), content: message.content });
        this.socket?.send(message?.content);
        message.status = MessageStatus.Sent;
    }
    pushMessageToQueue(message) {
        const id = crypto.randomUUID();
        this.messagesQueue.push({
            id,
            content: message,
            status: MessageStatus.Pending
        });
    }
    addMessage(message) {
        this.messages.push(message);
        this.emitMessage(message);
    }
    emitMessage(message) {
        this.listeners.message?.forEach(listener => {
            try {
                listener(message);
            }
            catch (e) {
                console.error(e);
            }
        });
    }
    emitStatus(status) {
        this.listeners.status?.forEach(listener => {
            try {
                listener(status);
            }
            catch (e) {
                console.error(e);
            }
        });
    }
    on(event, listener) {
        if (!this.listeners[event]) {
            this.listeners[event] = [];
        }
        this.listeners[event].push(listener);
    }
    off(event, listener) {
        const data = this.listeners[event];
        const index = data.indexOf(listener);
        if (index >= 0) {
            this.listeners[event].splice(index, 1);
        }
    }
    getMessages() {
        return [...this.messages];
    }
    disconnect() {
        this.messages = [];
        this.messagesQueue = [];
        if (this.socket) {
            this.socket.close(1000, "Closed by client");
        }
    }
    sendHeartBeat() {
        if (this.isConnected) {
            this.socket?.send('ping');
        }
    }
    startHeartBeat() {
        this.heartBeatInterval = window.setInterval(() => {
            this.sendHeartBeat();
        }, HEARTBEAT_INTERVAL);
    }
    stopHeartBeat() {
        window.clearInterval(this.heartBeatInterval);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9yYS1jbGllbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9sb3JhLWNsaWVudC9zcmMvc2VydmljZXMvbG9yYS1jbGllbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFdBQVcsTUFBTSxzQkFBc0IsQ0FBQztBQUUvQyxNQUFNLENBQU4sSUFBWSxnQkFLWDtBQUxELFdBQVksZ0JBQWdCO0lBQzFCLGlEQUE2QixDQUFBO0lBQzdCLDJDQUF1QixDQUFBO0lBQ3ZCLDZDQUF5QixDQUFBO0lBQ3pCLG1DQUFlLENBQUE7QUFDakIsQ0FBQyxFQUxXLGdCQUFnQixLQUFoQixnQkFBZ0IsUUFLM0I7QUFFRCxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDaEIsdURBQU8sQ0FBQTtJQUNQLGlEQUFJLENBQUE7QUFDTixDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFVRCxNQUFNLGtCQUFrQixHQUFHLEtBQUssQ0FBQztBQUVqQyxNQUFNLE9BQU8saUJBQWlCO0lBQ3BCLFVBQVUsR0FBRywwQ0FBMEMsQ0FBQztJQUN4RCxHQUFHLEdBQXVCLFNBQVMsQ0FBQztJQUNwQyxNQUFNLEdBQXFCLElBQUksQ0FBQztJQUNoQyxXQUFXLEdBQVksS0FBSyxDQUFDO0lBQzdCLE9BQU8sR0FBWSxLQUFLLENBQUM7SUFDekIsUUFBUSxHQUFvQixFQUFFLENBQUM7SUFDL0IsYUFBYSxHQUEwQixFQUFFLENBQUM7SUFDMUMsU0FBUyxHQUE0QyxFQUFFLENBQUM7SUFDeEQsaUJBQWlCLEdBQVcsQ0FBQyxDQUFDO0lBRXRDO1FBQ0UsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUFDLEtBQWE7UUFDL0IsTUFBTSxRQUFRLEdBQUcsTUFBTSxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVB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LENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUM5QyxDQUFDO0lBQ0gsQ0FBQztJQUdPLGFBQWE7UUFDbkIsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckIsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDNUIsQ0FBQztJQUNILENBQUM7SUFFTyxjQUFjO1FBQ3BCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUMvQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEIsQ0FBQyxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVPLGFBQWE7UUFDbkIsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUMvQyxDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NsaWVudE1lc3NhZ2V9IGZyb20gXCIuLi90eXBlcy9DbGllbnRNZXNzYWdlXCI7XG5pbXBvcnQgQ2xpZW50RXJyb3IgZnJvbSBcIi4uL3R5cGVzL0NsaWVudEVycm9yXCI7XG5cbmV4cG9ydCBlbnVtIENvbm5lY3Rpb25TdGF0dXMge1xuICBESVNDT05ORUNURUQgPSAnZGlzY29ubmVjdGVkJyxcbiAgQ09OTkVDVEVEID0gJ2Nvbm5lY3RlZCcsXG4gIENPTk5FQ1RJTkcgPSAnY29ubmVjdGluZycsXG4gIEVSUk9SID0gJ2Vycm9yJyxcbn1cblxuZW51bSBNZXNzYWdlU3RhdHVzIHtcbiAgUGVuZGluZyxcbiAgU2VudCxcbn1cblxudHlwZSBNZXNzYWdlUXVldWVNZXNzYWdlID0geyBpZDogc3RyaW5nLCBjb250ZW50OiBhbnksIHN0YXR1czogTWVzc2FnZVN0YXR1cyB9O1xudHlwZSBFdmVudHMgPSAnbWVzc2FnZScgfCAnc3RhdHVzJztcblxuaW50ZXJmYWNlIEV2ZW50TGlzdGVuZXJzIHtcbiAgbWVzc2FnZTogKG1lc3NhZ2U6IENsaWVudE1lc3NhZ2UpID0+IHZvaWQ7XG4gIHN0YXR1czogKHN0YXR1czogQ29ubmVjdGlvblN0YXR1cykgPT4gdm9pZDtcbn1cblxuY29uc3QgSEVBUlRCRUFUX0lOVEVSVkFMID0gMTIwMDA7XG5cbmV4cG9ydCBjbGFzcyBMb3JhQ2xpZW50U2VydmljZSB7XG4gIHByaXZhdGUgc2VydmljZVVybCA9ICdodHRwczovL2ZleW5zaW5uLmV4cGxvcmUuZGUvbG9yYS1taW5pcmFnJztcbiAgcHJpdmF0ZSB1cmw6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBzb2NrZXQ6IFdlYlNvY2tldCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGlzQ29ubmVjdGVkOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgaXNFcnJvcjogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIG1lc3NhZ2VzOiBDbGllbnRNZXNzYWdlW10gPSBbXTtcbiAgcHJpdmF0ZSBtZXNzYWdlc1F1ZXVlOiBNZXNzYWdlUXVldWVNZXNzYWdlW10gPSBbXTtcbiAgcHJpdmF0ZSBsaXN0ZW5lcnM6IHsgW0sgaW4gRXZlbnRzXT86IEV2ZW50TGlzdGVuZXJzW0tdW10gfSA9IHt9O1xuICBwcml2YXRlIGhlYXJ0QmVhdEludGVydmFsOiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGNvbnNvbGUubG9nKCdMb3JhQ2xpZW50U2VydmljZSBjb25zdHJ1Y3RvcicpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbih0b2tlbjogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3aW5kb3cuZmV0Y2goYCR7dGhpcy5zZXJ2aWNlVXJsfS9zZXNzaW9uYCwge1xuICAgICAgaGVhZGVyczogeyd4LWFwaS10b2tlbic6IHRva2VufVxuICAgIH0pO1xuICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMgPT09IDIwMCA/IGF3YWl0IHJlc3BvbnNlLnRleHQoKSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3Qob3B0aW9uczogeyBzZXNzaW9uSWQ6IHN0cmluZywgdXJsPzogc3RyaW5nLCBsb2FkSGlzdG9yeT86IGJvb2xlYW4gfSkge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IG9wdGlvbnMuc2Vzc2lvbklkO1xuICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmwgPz8gYCR7dGhpcy5zZXJ2aWNlVXJsfS93cy8ke3Nlc3Npb25JZH1gLnJlcGxhY2UoJ2h0dHBzOi8vJywgJ3dzczovLycpLnJlcGxhY2UoJ2h0dHA6Ly8nLCAnd3M6Ly8nKTtcblxuICAgIGlmICghc2Vzc2lvbklkKSB7XG4gICAgICB0aHJvdyBuZXcgQ2xpZW50RXJyb3IoJ0NhbiBub3Qgc3RhcnQgY29ubmVjdGlvbjogc2Vzc2lvbiBpZCBub3Qgc2V0LicpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudXJsKSB7XG4gICAgICB0aHJvdyBuZXcgQ2xpZW50RXJyb3IoJ0NhbiBub3Qgc3RhcnQgY29ubmVjdGlvbjogc2VydmVyIHVybCBub3Qgc2V0LicpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zb2NrZXQgJiYgdGhpcy5zb2NrZXQucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0LkNMT1NFRCkge1xuICAgICAgdGhyb3cgbmV3IENsaWVudEVycm9yKCdXZWJTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4gb3Igb3BlbmluZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgb2xkTWVzc2FnZXM6IENsaWVudE1lc3NhZ2VbXSA9IFtdO1xuICAgIGxldCByZXNvbHZlUHJvbWlzZTogKHZhbHVlPzogdW5rbm93bikgPT4gdm9pZDtcbiAgICBsZXQgcmVqZWN0UHJvbWlzZTogKHZhbHVlPzogYW55KSA9PiB2b2lkO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICByZXNvbHZlUHJvbWlzZSA9IHJlc29sdmU7XG4gICAgICByZWplY3RQcm9taXNlID0gcmVqZWN0O1xuXG4gICAgfSlcbiAgICB0aGlzLmVtaXRTdGF0dXMoQ29ubmVjdGlvblN0YXR1cy5DT05ORUNUSU5HKTtcbiAgICB0aGlzLmlzRXJyb3IgPSBmYWxzZTtcbiAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG5cbiAgICB0cnkge1xuXG4gICAgICBpZiAob3B0aW9ucy5sb2FkSGlzdG9yeSkge1xuICAgICAgICBvbGRNZXNzYWdlcyA9IGF3YWl0IHRoaXMuZ2V0TWVzc2FnZXNIaXN0b3J5KHNlc3Npb25JZCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc29ja2V0ID0gbmV3IFdlYlNvY2tldCh0aGlzLnVybCk7XG4gICAgICB0aGlzLnNvY2tldC5vbm9wZW4gPSAoKSA9PiB7XG4gICAgICAgIG9sZE1lc3NhZ2VzLmZvckVhY2gobWVzc2FnZSA9PiB0aGlzLmFkZE1lc3NhZ2UobWVzc2FnZSkpO1xuXG4gICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuc3RhcnRIZWFydEJlYXQoKTtcbiAgICAgICAgdGhpcy5lbWl0U3RhdHVzKENvbm5lY3Rpb25TdGF0dXMuQ09OTkVDVEVEKTtcblxuICAgICAgICByZXNvbHZlUHJvbWlzZSgpO1xuICAgICAgfTtcblxuICAgICAgdGhpcy5zb2NrZXQub25tZXNzYWdlID0gKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gZXZlbnQuZGF0YTtcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSAncGluZycgfHwgcmVzcG9uc2UgPT09ICdwb25nJykgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgdGhpcy5vblNvY2tldE1lc3NhZ2UocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICB0aGlzLnNvY2tldC5vbmNsb3NlID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc3RvcEhlYXJ0QmVhdCgpO1xuICAgICAgICB0aGlzLmVtaXRTdGF0dXModGhpcy5pc0Vycm9yID8gQ29ubmVjdGlvblN0YXR1cy5FUlJPUiA6IENvbm5lY3Rpb25TdGF0dXMuRElTQ09OTkVDVEVEKTtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuc29ja2V0Lm9uZXJyb3IgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5pc0Vycm9yID0gdHJ1ZTtcbiAgICAgICAgcmVqZWN0UHJvbWlzZT8uKGV2ZW50KTtcbiAgICAgIH07XG5cblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuICBhc3luYyBnZXRNZXNzYWdlc0hpc3Rvcnkoc2Vzc2lvbklkOiBzdHJpbmcpOiBQcm9taXNlPENsaWVudE1lc3NhZ2VbXT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgd2luZG93LmZldGNoKGAke3RoaXMuc2VydmljZVVybH0vJHtzZXNzaW9uSWR9L21lc3NhZ2VzYCk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICBjb25zdCBtZXNzYWdlcyA9IChkYXRhIHx8IFtdKS5tYXAoKGl0ZW06IGFueSkgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZTogQ2xpZW50TWVzc2FnZSA9IHtcbiAgICAgICAgaWQ6IGl0ZW0ubWVzc2FnZUlkLFxuICAgICAgICB1c2VyOiBpdGVtLmxvcmFNZXNzYWdlID8gJ2xvcmEnIDogJ21lJyxcbiAgICAgICAgY29udGVudDogaXRlbS50ZXh0LFxuICAgICAgICB0aW1lOiBpdGVtLmNyZWF0aW9uRGF0ZSxcbiAgICAgICAgcGFydHM6IGl0ZW0ucGFydHNcbiAgICAgIH1cbiAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lc3NhZ2VzLnJldmVyc2UoKTtcbiAgfVxuXG4gIHNlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRoaXMucHVzaE1lc3NhZ2VUb1F1ZXVlKG1lc3NhZ2UpO1xuICAgIHRoaXMucHJvY2Vzc1F1ZXVlKCk7XG4gIH1cblxuICBwcml2YXRlIG9uU29ja2V0TWVzc2FnZShkYXRhOiBzdHJpbmcpIHtcbiAgICBsZXQganNvbiA9IHVuZGVmaW5lZDtcbiAgICBsZXQgY29udGVudCA9ICcnO1xuICAgIGxldCBwYXJ0cyA9IFtdIGFzIHsgXCJhbmxhZ2VuS2VubnplaWNoZW5cIjogc3RyaW5nLCBcImdlb1wiOiBzdHJpbmcgfVtdO1xuICAgIHRyeSB7XG4gICAgICBqc29uID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgIGNvbnRlbnQgPSBqc29uLmFuc3dlcjtcbiAgICAgIHBhcnRzID0ganNvbi5wYXJ0cztcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb250ZW50ID0gZGF0YTtcbiAgICB9XG4gICAgY29uc3QgbWVzc2FnZSA9IHtpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSBhcyBzdHJpbmcsIHVzZXI6ICdsb3JhJywgY29udGVudCwgcGFydHMsIHRpbWU6IERhdGUubm93KCl9O1xuICAgIHRoaXMuYWRkTWVzc2FnZShtZXNzYWdlKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc1F1ZXVlKCkge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2VzUXVldWUucG9wKCk7XG4gICAgaWYgKCFtZXNzYWdlKSByZXR1cm47XG5cbiAgICB0aGlzLmFkZE1lc3NhZ2Uoe2lkOiBtZXNzYWdlLmlkLCB1c2VyOiAnbWUnLCB0aW1lOiBEYXRlLm5vdygpLCBjb250ZW50OiBtZXNzYWdlLmNvbnRlbnR9KVxuICAgIHRoaXMuc29ja2V0Py5zZW5kKG1lc3NhZ2U/LmNvbnRlbnQpO1xuICAgIG1lc3NhZ2Uuc3RhdHVzID0gTWVzc2FnZVN0YXR1cy5TZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBwdXNoTWVzc2FnZVRvUXVldWUobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgY29uc3QgaWQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuXG4gICAgdGhpcy5tZXNzYWdlc1F1ZXVlLnB1c2goe1xuICAgICAgaWQsXG4gICAgICBjb250ZW50OiBtZXNzYWdlLFxuICAgICAgc3RhdHVzOiBNZXNzYWdlU3RhdHVzLlBlbmRpbmdcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTWVzc2FnZShtZXNzYWdlOiBDbGllbnRNZXNzYWdlKSB7XG4gICAgdGhpcy5tZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuXG4gICAgdGhpcy5lbWl0TWVzc2FnZShtZXNzYWdlKTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdE1lc3NhZ2UobWVzc2FnZTogQ2xpZW50TWVzc2FnZSkge1xuICAgIHRoaXMubGlzdGVuZXJzLm1lc3NhZ2U/LmZvckVhY2gobGlzdGVuZXIgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGlzdGVuZXIobWVzc2FnZSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRTdGF0dXMoc3RhdHVzOiBDb25uZWN0aW9uU3RhdHVzKSB7XG4gICAgdGhpcy5saXN0ZW5lcnMuc3RhdHVzPy5mb3JFYWNoKGxpc3RlbmVyID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxpc3RlbmVyKHN0YXR1cyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBvbjxUIGV4dGVuZHMgRXZlbnRzPihldmVudDogVCwgbGlzdGVuZXI6IEV2ZW50TGlzdGVuZXJzW1RdKSB7XG4gICAgaWYgKCF0aGlzLmxpc3RlbmVyc1tldmVudF0pIHtcbiAgICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50XSA9IFtdO1xuICAgIH1cbiAgICAodGhpcy5saXN0ZW5lcnNbZXZlbnRdIGFzIGFueVtdKS5wdXNoKGxpc3RlbmVyKTtcbiAgfVxuXG4gIG9mZjxLIGV4dGVuZHMgRXZlbnRzPihldmVudDogSywgbGlzdGVuZXI6IEV2ZW50TGlzdGVuZXJzW0tdKSB7XG4gICAgY29uc3QgZGF0YSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50XSBhcyBhbnlbXTtcbiAgICBjb25zdCBpbmRleCA9IGRhdGEuaW5kZXhPZihsaXN0ZW5lcik7XG5cbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgKHRoaXMubGlzdGVuZXJzW2V2ZW50XSBhcyBbXSkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG4gIH1cblxuICBnZXRNZXNzYWdlcygpIHtcbiAgICByZXR1cm4gWy4uLnRoaXMubWVzc2FnZXNdO1xuICB9XG5cbiAgZGlzY29ubmVjdCgpIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gW107XG4gICAgdGhpcy5tZXNzYWdlc1F1ZXVlID0gW107XG4gICAgaWYgKHRoaXMuc29ja2V0KSB7XG4gICAgICB0aGlzLnNvY2tldC5jbG9zZSgxMDAwLCBcIkNsb3NlZCBieSBjbGllbnRcIik7XG4gICAgfVxuICB9XG5cblxuICBwcml2YXRlIHNlbmRIZWFydEJlYXQoKSB7XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQpIHtcbiAgICAgIHRoaXMuc29ja2V0Py5zZW5kKCdwaW5nJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGFydEhlYXJ0QmVhdCgpIHtcbiAgICB0aGlzLmhlYXJ0QmVhdEludGVydmFsID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuc2VuZEhlYXJ0QmVhdCgpXG4gICAgfSwgSEVBUlRCRUFUX0lOVEVSVkFMKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RvcEhlYXJ0QmVhdCgpIHtcbiAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aGlzLmhlYXJ0QmVhdEludGVydmFsKTtcbiAgfVxuXG59XG4iXX0=